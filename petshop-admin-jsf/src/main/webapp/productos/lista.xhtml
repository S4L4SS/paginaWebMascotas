<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:f="http://xmlns.jcp.org/jsf/core"
      xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
      xmlns:b="http://bootsfaces.net/ui"
      xmlns:p="http://primefaces.org/ui">

<ui:composition template="/WEB-INF/templates/layout.xhtml">
    <ui:define name="title">Gestión de Productos - PetShop Admin</ui:define>
    
    <ui:define name="content">
        <!-- Recargar productos al entrar a la página -->
        <f:metadata>
            <f:viewAction action="#{productoBean.recargarProductos()}"/>
        </f:metadata>
        
        <h:form id="productosForm">
            <!-- Mensajes de feedback -->
            <b:messages/>
            
            <!-- Header -->
            <b:row>
                <b:column col-md="8">
                    <h1>
                        <b:iconAwesome name="shopping-cart"/> Gestión de Productos
                    </h1>
                </b:column>
                <b:column col-md="4" style="text-align: right; padding-top: 20px;">
                    <h:link outcome="/productos/nuevo" 
                           styleClass="btn btn-success btn-lg"
                           value="+ Nuevo Producto"/>
                </b:column>
            </b:row>
            
            <hr/>
            
            <!-- Búsqueda -->
            <b:row style="margin-bottom: 20px;">
                <b:column col-md="10">
                    <b:inputText value="#{productoBean.terminoBusqueda}" 
                                placeholder="Buscar productos por nombre..."
                                style="width: 100%;">
                        <f:ajax event="keyup" render="productosTable" 
                               listener="#{productoBean.buscarProductos}"/>
                    </b:inputText>
                </b:column>
                <b:column col-md="2">
                    <b:commandButton value="Buscar" 
                                    action="#{productoBean.buscarProductos()}"
                                    update="productosTable"
                                    look="primary"
                                    icon="search"
                                    style="width: 100%;"/>
                    <b:commandButton value="Limpiar" 
                                    action="#{productoBean.limpiarBusqueda()}"
                                    update="productosTable"
                                    look="default"
                                    icon="times"
                                    style="width: 100%; margin-top: 5px;"/>
                </b:column>
            </b:row>
            
            <!-- DataTable con JSF (PrimeFaces) -->
            <b:row>
                <b:column>
                    <p:dataTable id="productosTable" 
                                var="producto" 
                                value="#{productoBean.productos}"
                                rowKey="#{producto.idProducto}"
                                paginator="true" 
                                rows="20"
                                paginatorPosition="both"
                                paginatorTemplate="{CurrentPageReport} {FirstPageLink} {PreviousPageLink} {PageLinks} {NextPageLink} {LastPageLink} {RowsPerPageDropdown}"
                                rowsPerPageTemplate="10,20,50"
                                currentPageReportTemplate="Mostrando {startRecord}-{endRecord} de {totalRecords} productos"
                                lazy="false"
                                emptyMessage="No se encontraron productos"
                                styleClass="table-striped"
                                responsive="true">
                        
                        <f:facet name="header">
                            Catálogo de Productos (#{productoBean.productos.size()} productos)
                        </f:facet>
                        
                        <p:column headerText="ID" sortBy="#{producto.idProducto}" style="width: 60px;">
                            <h:outputText value="#{producto.idProducto}"/>
                        </p:column>
                        
                        <p:column headerText="Imagen" style="width: 100px;">
                            <h:graphicImage value="#{producto.imagen != null ? '/images/'.concat(producto.imagen) : '/resources/images/no-image.svg'}" 
                                          width="60" 
                                          height="60"
                                          style="object-fit: cover; border-radius: 5px;"/>
                        </p:column>
                        
                        <p:column headerText="Nombre" sortBy="#{producto.nombre}">
                            <h:outputText value="#{producto.nombre}" style="font-weight: bold;"/>
                        </p:column>
                        
                        <p:column headerText="Descripción" style="max-width: 300px;">
                            <h:outputText value="#{producto.descripcion}"/>
                        </p:column>
                        
                        <p:column headerText="Precio" sortBy="#{producto.precio}" style="width: 100px;">
                            <h:outputText value="S/. #{producto.precio}">
                                <f:convertNumber pattern="#,##0.00"/>
                            </h:outputText>
                        </p:column>
                        
                        <p:column headerText="Stock" sortBy="#{producto.stock}" style="width: 150px;">
                            <h:panelGroup id="stockPanel_#{producto.idProducto}">
                                <p:inputText id="stockInput_#{producto.idProducto}" 
                                           value="#{producto.stock}" 
                                           style="width: 60px; text-align: center;">
                                    <f:convertNumber integerOnly="true"/>
                                </p:inputText>
                                
                                <!-- Botón AJAX con PrimeFaces (más confiable que jQuery) -->
                                <p:commandButton icon="ui-icon-refresh"
                                               styleClass="ui-button-info ui-button-sm"
                                               style="margin-left: 5px;"
                                               action="#{productoBean.actualizarStock(producto)}"
                                               update="@form"
                                               title="Actualizar stock"/>
                                
                                <br/>
                                <p:badge value="#{producto.estadoStock}" 
                                        severity="#{producto.stock > 10 ? 'success' : (producto.stock > 0 ? 'warning' : 'danger')}"/>
                            </h:panelGroup>
                        </p:column>
                        
                        <p:column headerText="Acciones" style="width: 150px; text-align: center;">
                            <b:commandButton icon="edit" 
                                           look="warning" 
                                           size="sm"
                                           action="#{productoBean.prepararEdicion(producto)}"
                                           title="Editar"/>
                            <b:commandButton icon="trash" 
                                           look="danger" 
                                           size="sm"
                                           style="margin-left: 5px;"
                                           action="#{productoBean.eliminarProducto(producto)}"
                                           update="productosTable"
                                           onclick="return confirm('¿Está seguro de eliminar este producto?');"
                                           title="Eliminar"/>
                        </p:column>
                    </p:dataTable>
                </b:column>
            </b:row>
        </h:form>
    </ui:define>
</ui:composition>
</html>
